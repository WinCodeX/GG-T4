<%= turbo_frame_tag :dashboard do %>
  <div class="flex h-[calc(100vh-4rem)] mt-16">

    <!-- ğŸ’¬ Chat List Sidebar -->
    <aside class="w-80 bg-[#1e1f29] border-r border-[#44475a] overflow-y-auto p-4">
      <h2 class="text-lg font-semibold text-[#f8f8f2] mb-4">Your Chats</h2>

      <% @chat_rooms.each do |room| %>
        <% recipient = room.other_participant(current_user) %>
        <%= link_to chat_room_path(room),
              data: { turbo_frame: "dashboard" },
              class: "block mb-2 p-3 rounded-lg bg-[#282a36] text-[#f8f8f2] hover:bg-[#44475a] transition" do %>
          <div class="flex items-center gap-3">
            <% if recipient.avatar.attached? %>
              <%= image_tag recipient.avatar.variant(resize_to_fill: [40, 40]), class: "rounded-full h-10 w-10 object-cover" %>
            <% else %>
              <%= image_tag avatar_url_for(recipient), class: "rounded-full h-10 w-10 object-cover" %>
            <% end %>
            <div>
              <div class="font-medium"><%= recipient.username || recipient.email.split('@').first %></div>
              <div class="text-xs text-[#6272a4]">Last message preview here</div>
            </div>
          </div>
        <% end %>
      <% end %>
    </aside>

    <!-- ğŸ“¨ Chat Room Panel -->
    <div class="flex-1 bg-[#0d0d0d] h-full">
      <% if @chat_room.present? %>
        <div class="h-full w-full flex flex-col text-white">

          <!-- ğŸ’¬ Chat Header -->
          <div class="sticky top-0 z-40 bg-[#1e1f29] px-4 py-2 flex items-center justify-between border-b border-[#44475a]">
            <div class="flex items-center space-x-3">
              <%= render "shared/user_avatar_with_name", user: @chat_with %>
            </div>
            <div class="flex space-x-4 text-gray-300">
              <!-- icons -->
            </div>
          </div>

          <!-- ğŸ’¬ Messages -->
          <div id="messages" class="flex-1 w-full overflow-y-auto px-4 py-3 space-y-3">
            <%= turbo_stream_from @chat_room %>
            <% @messages.each do |message| %>
              <% mine = message.user_id == current_user.id %>
              <div class="flex <%= mine ? 'justify-end' : 'justify-start' %>">
                <div class="<%= mine ? 'bg-[#005c4b]' : 'bg-[#1e1f29]' %> max-w-[75%] px-4 py-2 rounded-2xl shadow-sm">
                  <div class="whitespace-pre-line text-sm"><%= message.body %></div>
                  <div class="text-[11px] text-gray-400 mt-1 text-right">
                    <%= message.created_at.strftime("%H:%M") %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>

          <!-- âœï¸ Input -->
          <div class="w-full sticky bottom-0 p-4 bg-[#1e1f29] flex items-center">
            <%= form_with(model: [@chat_room, Message.new], data: { turbo_stream: true }, class: "flex w-full items-center gap-2") do |f| %>
              <div class="relative flex-1">
                <%= f.text_area :body, placeholder: "Type a message...", rows: 1,
                      class: "w-full resize-none p-2 pr-12 rounded-full bg-[#282a36] text-white border border-[#44475a] focus:outline-none focus:ring-2 focus:ring-[#bd93f9] text-sm py-2 px-4" %>

                <div class="absolute right-4 top-0.5 flex items-center">
                  <%= button_tag type: "submit", class: "text-[#bd93f9] hover:text-white transition" do %>
                    <!-- send icon -->
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>

        </div>
      <% else %>
        <!-- Placeholder -->
        <div class="h-full flex items-center justify-center text-[#6272a4]">
          Select a chat to start messaging.
        </div>
      <% end %>
    </div>

  </div>
<% end %>